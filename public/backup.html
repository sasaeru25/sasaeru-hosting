<!-- /public/backup.html : ç«¯æœ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆæ›¸ãå‡ºã—/å¾©å…ƒï¼‰Firebaseç‰ˆï¼ˆãƒ•ãƒ«HTMLï¼‰ -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#FFF9F2" />
  <title>ç«¯æœ«ã«ã¡ã‚ƒã‚“ã¨æ®‹ã™ï½œã•ã•ã‚¨ãƒ¼ãƒ«</title>

  <!-- å…±é€šï¼ˆFirebaseå´ï¼‰ -->
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#f3a9a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<link rel="icon" href="/icons/favicon-32.png" sizes="32x32">

<link rel="stylesheet" href="/css/common.css">
  <script src="/js/common.js" defer></script>
  <script src="/js/store.js" defer></script>

  <style>
    :root{
      --bg:#FFF9F2;
      --accent:#FFDC65;
      --border:#e6e6e6;
      --purple:#6a1b9a;
      --sh-1:0 3px 10px rgba(0,0,0,.08);
      --safe-bottom:env(safe-area-inset-bottom);
    }
    body{margin:0;background:var(--bg);color:#333;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    main{padding-bottom:calc(28px + var(--safe-bottom));}

    .backup-page{max-width:720px;margin:0 auto;padding:20px 14px 34px;}
    .page-head{margin:10px 0 16px;text-align:left;}
    .page-head h2{
      margin:0 0 10px;
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 18px;border-radius:999px;background:#fff;border:1px solid var(--border);
      font-weight:900;font-size:1.05rem;
    }
    .backup-note{
      background:#fff3e0;border-radius:10px;padding:10px 12px;
      text-align:left;line-height:1.7;border:1px solid #f3e1c8;
    }

    .backup-card{
      background:#fff;border-radius:14px;box-shadow:var(--sh-1);
      padding:14px 14px 16px;text-align:left;border:1px solid #eee;
    }
    .backup-card h3{margin:4px 0 8px;font-size:1.05rem;}
    .muted{color:#666;font-size:.92rem;line-height:1.7;}
    .warn{
      background:#fff7f7;border:1px solid #f0caca;border-radius:10px;
      padding:10px 12px;line-height:1.6;
    }

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      min-height:52px;padding:12px 16px;border-radius:16px;
      background:#fff;border:1px solid #ddd;text-decoration:none;
      color:#111;font-weight:900;cursor:pointer;
      box-shadow:0 10px 16px rgba(0,0,0,.08);
    }
    .btn.secondary{
      background:var(--accent);
      border:1px solid #e7cf6a;
      box-shadow:0 10px 16px rgba(0,0,0,.10);
    }

    .top-links{
      display:flex;gap:12px;flex-wrap:wrap;
      margin:14px 0 0;justify-content:flex-start;
    }
    .link{
      color:var(--purple);text-decoration:none;font-weight:900;
      display:inline-flex;align-items:center;gap:6px;
    }
  </style>
</head>

<body>
  <main class="backup-page" aria-labelledby="backup-title">
    <div class="page-head">
      <h2 id="backup-title">ğŸ§· ç«¯æœ«ã«ã¡ã‚ƒã‚“ã¨æ®‹ã™</h2>
      <p class="backup-note">
        ã“ã“ã§ä½œã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ã€ç«¯æœ«ï¼ˆFiles/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
        iPhoneã®ç’°å¢ƒã§è¨˜éŒ²ãŒæ¶ˆãˆã‚‹å ´åˆã§ã‚‚ã€ã“ã“ã‹ã‚‰å¾©å…ƒã§ãã¾ã™ã€‚
      </p>
      <div class="top-links">
        <a class="link" href="/diary.html">â† è¨˜éŒ²ãƒˆãƒƒãƒ—</a>
        <a class="link" href="/diary-list.html">ä¸€è¦§</a>
      </div>
    </div>

    <section class="backup-card">
      <h3>â‘  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œã‚‹ï¼ˆæ›¸ãå‡ºã—ï¼‰</h3>
      <p class="muted">æ—¥è¨˜ï¼‹ã‚¯ãƒªãƒƒãƒ—ã‚’ã¾ã¨ã‚ã¦1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¾ã™ã€‚</p>
      <button id="btn-export" class="btn secondary" type="button">ç«¯æœ«ã«æ®‹ã™ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼‰</button>
      <p id="export-status" class="muted" style="margin-top:.6rem;"></p>
    </section>

    <section class="backup-card" style="margin-top:16px;">
      <h3>â‘¡ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆèª­ã¿è¾¼ã¿ï¼‰</h3>
      <p class="muted">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨ã€ã‚¢ãƒ—ãƒªå†…ã®è¨˜éŒ²ãŒå¾©å…ƒã•ã‚Œã¾ã™ã€‚</p>

      <input id="file" type="file" accept="application/json,.json" hidden>
      <button id="btn-pick" class="btn" type="button">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶</button>

      <div class="warn" style="margin-top:12px;">
        <strong>æ³¨æ„ï¼š</strong>å¾©å…ƒã™ã‚‹ã¨ã€ç¾åœ¨ã®ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚<br>
        è¿·ã†å ´åˆã¯ã€å…ˆã«ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å¾©å…ƒã—ã¦ãã ã•ã„ã€‚
      </div>

      <p id="import-status" class="muted" style="margin-top:.6rem;"></p>
    </section>

    <section class="backup-card" style="margin-top:16px;">
      <h3>å›°ã£ãŸã¨ã</h3>
      <ul style="text-align:left;line-height:1.8;margin:0;padding-left:1.1rem;">
        <li>iPhoneï¼šä¿å­˜å…ˆã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªï¼ˆã“ã®iPhoneå†… / iCloud Driveï¼‰ã«ã‚ã‚Šã¾ã™</li>
        <li>Androidï¼šä¿å­˜å…ˆã¯ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚„ã€ŒFilesã€ã«å…¥ã‚‹ã“ã¨ãŒå¤šã„ã§ã™</li>
        <li>è¦‹ã¤ã‹ã‚‰ãªã„ã¨ãã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åã€Œsasaeru-backup-æ—¥ä»˜.jsonã€ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</li>
      </ul>
    </section>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // ---- ä¾å­˜ï¼šstore.js å´ã§æä¾›ã•ã‚Œã¦ã„ã‚‹æƒ³å®š ----
    // window.loadRecords / saveRecordsï¼ˆæ—¥è¨˜ï¼‰
    // window.loadClips   / saveClipsï¼ˆã‚¯ãƒªãƒƒãƒ—ï¼‰
    const hasDiary = (typeof window.loadRecords === 'function' && typeof window.saveRecords === 'function');
    const hasClips = (typeof window.loadClips   === 'function' && typeof window.saveClips   === 'function');

    const $ = (id) => document.getElementById(id);

    const btnExport = $('btn-export');
    const exportStatus = $('export-status');
    const btnPick = $('btn-pick');
    const fileInput = $('file');
    const importStatus = $('import-status');

    function nowJST_yyyymmdd() {
      // JSTã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½œã‚‹ï¼ˆç«¯æœ«ã§ã‚‚è¦‹ã¤ã‘ã‚„ã™ãï¼‰
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    async function buildBackupObject() {
      const diaries = hasDiary ? (await window.loadRecords()) : [];
      const clips   = hasClips ? (await window.loadClips())   : [];

      return {
        schema: 'sasaeru-backup',
        version: 1,
        exportedAt: new Date().toISOString(),
        app: 'ã•ã•ã‚¨ãƒ¼ãƒ«',
        diaries,
        clips
      };
    }

    function downloadJson(obj) {
      const json = JSON.stringify(obj, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url  = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `sasaeru-backup-${nowJST_yyyymmdd()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 4000);
    }

    async function exportBackup() {
      exportStatus.textContent = '';
      try {
        const obj = await buildBackupObject();
        downloadJson(obj);
        exportStatus.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ä¿å­˜å…ˆï¼ˆFiles/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      } catch (e) {
        console.error(e);
        exportStatus.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      }
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ''));
        fr.onerror = () => reject(fr.error || new Error('read failed'));
        fr.readAsText(file);
      });
    }

    function validateBackup(obj) {
      if (!obj || typeof obj !== 'object') return 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å½¢å¼ãŒä¸æ­£ã§ã™ã€‚';
      if (obj.schema !== 'sasaeru-backup') return 'ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œã•ã•ã‚¨ãƒ¼ãƒ«ã€ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
      if (obj.version !== 1) return 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¯¾å¿œå¤–ã§ã™ã€‚';
      if (!Array.isArray(obj.diaries)) return 'æ—¥è¨˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      if (!Array.isArray(obj.clips)) return 'ã‚¯ãƒªãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
      return '';
    }

    async function importBackupFromFile(file) {
      importStatus.textContent = '';
      try {
        const text = await readFileAsText(file);
        const obj = JSON.parse(text);

        const err = validateBackup(obj);
        if (err) {
          importStatus.textContent = err;
          return;
        }

        const ok = confirm(
          'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã™ã€‚\n' +
          'ç¾åœ¨ã®ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\n' +
          'å…ˆã«ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¾ã—ãŸã‹ï¼Ÿ\n\n' +
          'OKãªã‚‰å¾©å…ƒã—ã¾ã™ã€‚'
        );
        if (!ok) {
          importStatus.textContent = 'å¾©å…ƒã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚';
          return;
        }

        if (!hasDiary || !hasClips) {
          importStatus.textContent = 'å¾©å…ƒã«å¿…è¦ãªã‚¹ãƒˆã‚¢é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆstore.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰ã€‚';
          return;
        }

        await window.saveRecords(obj.diaries || []);
        await window.saveClips(obj.clips || []);

        importStatus.textContent = `å¾©å…ƒã—ã¾ã—ãŸï¼ˆæ—¥è¨˜ ${obj.diaries.length}ä»¶ / ã‚¯ãƒªãƒƒãƒ— ${obj.clips.length}ä»¶ï¼‰ã€‚`;
        alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ—¥è¨˜ãƒ»ã‚¯ãƒªãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      } catch (e) {
        console.error(e);
        importStatus.textContent = 'å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      }
    }

    btnExport?.addEventListener('click', exportBackup);

    btnPick?.addEventListener('click', () => fileInput?.click());
    fileInput?.addEventListener('change', async () => {
      const f = fileInput.files && fileInput.files[0];
      fileInput.value = '';
      if (!f) return;
      await importBackupFromFile(f);
    });

    if (!hasDiary || !hasClips) {
      const msg = [];
      if (!hasDiary) msg.push('æ—¥è¨˜ã‚¹ãƒˆã‚¢ï¼ˆloadRecords/saveRecordsï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      if (!hasClips) msg.push('ã‚¯ãƒªãƒƒãƒ—ã‚¹ãƒˆã‚¢ï¼ˆloadClips/saveClipsï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      importStatus.textContent = 'æ³¨æ„ï¼š' + msg.join(' / ');
    }
  });
  </script>
</body>
</html>