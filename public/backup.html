<!-- /public/backup.html : ç«¯æœ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆæ›¸ãå‡ºã—/å¾©å…ƒï¼‰-->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ç«¯æœ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— | ã•ã•ã‚¨ãƒ¼ãƒ«</title>

<link rel="stylesheet" href="/css/common.css">

<!-- å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆidb-keyval, go(), ãªã©ï¼‰ -->
<script defer src="/js/lib.js"></script>
<!-- IndexedDB ï¼‹ localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ãƒˆã‚¢ -->
<script defer src="/js/store.js"></script>

<!-- å°ã•ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨å¤‰æ•° -->
<style>:root{--sh-1:0 3px 10px rgba(0,0,0,.08);}</style>
</head>
<body>

<main class="backup-page" aria-labelledby="backup-title">
  <div class="page-head">
    <h2 id="backup-title">ğŸ§· ç«¯æœ«ã«ã¡ã‚ƒã‚“ã¨æ®‹ã™</h2>
    <p class="backup-note">
      ã“ã“ã§ä½œã‚‹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ã€ç«¯æœ«ï¼ˆFiles / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
      iPhoneã®ç’°å¢ƒã§è¨˜éŒ²ãŒæ¶ˆãˆã‚‹å ´åˆã§ã‚‚ã€ã“ã“ã‹ã‚‰å¾©å…ƒã§ãã¾ã™ã€‚
    </p>
  </div>

  <!-- â”€â”€â”€â”€â”€ ä½œæˆ â”€â”€â”€â”€â”€ -->
  <section class="backup-card">
    <h3>â‘  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œã‚‹ï¼ˆæ›¸ãå‡ºã—ï¼‰</h3>
    <p class="muted">æ—¥è¨˜ï¼‹ã‚¯ãƒªãƒƒãƒ—ã‚’ã¾ã¨ã‚ã¦ 1 ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã—ã¾ã™ã€‚</p>
    <button id="btn-export" class="btn secondary" type="button">
      ç«¯æœ«ã«æ®‹ã™ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼‰
    </button>
    <p id="export-status" class="muted" style="margin-top:.6rem;"></p>
  </section>

  <!-- â”€â”€â”€â”€â”€ å¾©å…ƒ â”€â”€â”€â”€â”€ -->
  <section class="backup-card" style="margin-top:16px;">
    <h3>â‘¡ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã™ã‚‹ï¼ˆèª­ã¿è¾¼ã¿ï¼‰</h3>
    <p class="muted">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã¨ã€ã‚¢ãƒ—ãƒªå†…ã®è¨˜éŒ²ãŒå¾©å…ƒã•ã‚Œã¾ã™ã€‚</p>

    <input id="file" type="file" accept="application/json,.json" hidden>
    <button id="btn-pick" class="btn" type="button">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶</button>

    <div class="warn" style="margin-top:12px;">
      <strong>æ³¨æ„ï¼š</strong>å¾©å…ƒã™ã‚‹ã¨ã€ç¾åœ¨ã®ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã‚’<strong>ä¸Šæ›¸ã</strong>ã—ã¾ã™ã€‚<br>
      è¿·ã†å ´åˆã¯ã€å…ˆã«ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œã‚‹ã€ã‚’æŠ¼ã—ã¦ã‹ã‚‰å¾©å…ƒã—ã¦ãã ã•ã„ã€‚
    </div>

    <p id="import-status" class="muted" style="margin-top:.6rem;"></p>
  </section>

  <!-- â”€â”€â”€â”€â”€ ãƒ˜ãƒ«ãƒ— â”€â”€â”€â”€â”€ -->
  <section class="backup-card" style="margin-top:16px;">
    <h3>å›°ã£ãŸã¨ã</h3>
    <ul style="text-align:left;line-height:1.8;margin:0;padding-left:1.1rem;">
      <li>iPhoneï¼šä¿å­˜å…ˆã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªï¼ˆã“ã® iPhone å†… / iCloud Driveï¼‰ã«ã‚ã‚Šã¾ã™</li>
      <li>Androidï¼šä¿å­˜å…ˆã¯ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚„ã€ŒFilesã€ã«å…¥ã‚‹ã“ã¨ãŒå¤šã„ã§ã™</li>
      <li>è¦‹ã¤ã‹ã‚‰ãªã„ã¨ãã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å <code>sasaeru-backup-æ—¥ä»˜.json</code> ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</li>
    </ul>
  </section>
</main>

<!-- â”€â”€â”€â”€â”€ ç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« â”€â”€â”€â”€â”€ -->
<style>
  body{margin:0;font-family:"Noto Sans JP",system-ui,sans-serif;background:#FFF9F2;color:#333;}
  .backup-page{max-width:720px;margin:0 auto;padding:20px 14px 34px;}
  .page-head{margin:10px 0 16px;}
  .backup-note{background:#fff3e0;border-radius:10px;padding:10px 12px;text-align:left;line-height:1.7;}
  .backup-card{background:#fff;border-radius:14px;box-shadow:var(--sh-1);padding:14px 14px 16px;text-align:left;}
  .backup-card h3{margin:4px 0 8px;font-size:1.05rem;font-weight:800;}
  .muted{color:#666;font-size:.92rem;}
  .warn{background:#fff7f7;border:1px solid #f0caca;border-radius:10px;padding:10px 12px;line-height:1.6;}
  .btn{border:none;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer;font-size:1rem;}
  .btn.secondary{background:#FFDC65;} .btn{background:#fff;border:1px solid #ddd;color:#6a1b9a;}
</style>

<!-- â”€â”€â”€â”€â”€ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ â”€â”€â”€â”€â”€ -->
<script>
(() => {
  /* store.js ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤ */
  const ready = () => new Promise(r => {
    if (window.__STORE_READY__) return r();
    const id = setInterval(() => {
      if (window.__STORE_READY__ || window.__STORE_ERROR__) {
        clearInterval(id); r();
      }
    }, 50);
  });

  const $ = id => document.getElementById(id);
  const btnExport = $('btn-export');
  const exportSt  = $('export-status');
  const btnPick   = $('btn-pick');
  const fileInput = $('file');
  const importSt  = $('import-status');

  function today() {
    const d=new Date(), p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  }
  const schema = 'sasaeru-backup', ver = 1;

  async function buildBackup() {
    const diaries = await (window.loadRecords?.() ?? []);
    const clips   = await (window.loadClips?.()   ?? []);
    return {schema,version:ver,exportedAt:new Date().toISOString(),app:'ã•ã•ã‚¨ãƒ¼ãƒ«',diaries,clips};
  }
  function saveJson(obj){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=`sasaeru-backup-${today()}.json`;
    document.body.append(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),4e3);
  }

  /* ---------- export ---------- */
  async function doExport(){
    exportSt.textContent='';
    try{ saveJson(await buildBackup());
      exportSt.textContent='ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    }catch(e){console.error(e);exportSt.textContent='ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';}
  }

  /* ---------- import ---------- */
  const readText=f=>new Promise((ok,ng)=>{const r=new FileReader();
    r.onload=()=>ok(String(r.result));r.onerror=()=>ng(r.error);r.readAsText(f);});
  function validate(o){
    if(o?.schema!==schema) return 'ã€Œã•ã•ã‚¨ãƒ¼ãƒ«ã€ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
    if(o?.version!==ver)   return 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¯¾å¿œå¤–ã§ã™';
    if(!Array.isArray(o.diaries)||!Array.isArray(o.clips)) return 'ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã¾ã™';
    return '';
  }
  async function importFile(f){
    importSt.textContent='';
    try{
      const obj=JSON.parse(await readText(f));
      const err=validate(obj); if(err){importSt.textContent=err;return;}
      if(!confirm('å¾©å…ƒã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šã‘ã¾ã™ã‹ï¼Ÿ')) return;
      await window.saveRecords?.(obj.diaries); await window.saveClips?.(obj.clips);
      importSt.textContent=`å¾©å…ƒã—ã¾ã—ãŸï¼ˆæ—¥è¨˜ ${obj.diaries.length} ä»¶ / ã‚¯ãƒªãƒƒãƒ— ${obj.clips.length} ä»¶ï¼‰`;
      alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚æ—¥è¨˜ãƒ»ã‚¯ãƒªãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }catch(e){console.error(e);importSt.textContent='å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ';}
  }

  /* ---------- init ---------- */
  ready().then(()=>{
    btnExport?.addEventListener('click',doExport);
    btnPick?.addEventListener('click',()=>fileInput?.click());
    fileInput?.addEventListener('change',e=>{
      const f=e.target.files?.[0]; fileInput.value=''; if(f) importFile(f);
    });
    if(!window.loadRecords||!window.saveRecords||!window.loadClips||!window.saveClips){
      importSt.textContent='æ³¨æ„ï¼šã‚¹ãƒˆã‚¢é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆstore.js ã‚’ç¢ºèªï¼‰';
    }
  });
})();
</script>
</body>
</html>
