<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>フリースクール等</title>

  <!-- ===== 芯（共通・必須）===== -->
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#f3a9a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<link rel="icon" href="/icons/favicon-32.png" sizes="32x32">

<link rel="stylesheet" href="/css/common.css">
  <script defer src="/js/common.js"></script>
  <script defer src="/js/lib.js"></script>
  <script defer src="/js/store.js"></script>

  <!-- ===== CSS（表示まわり：元コードそのまま + 中央寄せだけ）===== -->
  <style>
  :root{
    --mint:#caf4d6;
    --row-mint:#eaf8f1;
    --shadow:0 6px 12px rgba(0,0,0,.15);
  }
  body{margin:0;background:var(--mint);font-family:"Noto Sans JP",system-ui,sans-serif;color:#222;}

  /* ★追加：ページの上部（見出し＆検索）を中央寄せ */
  .wrapper{
    max-width:430px;
    margin:0 auto;
    padding:1rem;
    text-align:center;
  }
  @media (min-width:768px){.wrapper{max-width:960px;}}

  .badge{
    display:inline-block;padding:.65rem 2rem;margin:0 0 22px;
    border-radius:999px;background:linear-gradient(#fff,#f3f4f8);
    font:700 clamp(18px,5vw,26px) "Noto Sans JP";
    box-shadow:var(--shadow);
  }
  .badge img{width:1.4em;vertical-align:-.2em;margin-right:.2em}

  /* 説明文・表は左寄せのまま */
  .desc{
    background:#fff;padding:1.4rem .9rem;margin-bottom:1.8rem;line-height:1.7;
    font-size:clamp(14px,4.2vw,17px);box-shadow:0 3px 6px rgba(0,0,0,.1);
    text-align:left;
  }

  /* ★追加：検索欄を中央寄せ（wrapperでも中央だが保険） */
  #filterWrap{
    font-size:1rem;
    margin-bottom:1rem;
    text-align:center;
  }
  #selRegion{font-size:1rem;padding:.35rem .6rem;display:inline-block;}

  /* 表は左寄せ */
  #tblWrap{overflow:visible;text-align:left;}
  .table-wrap{overflow-x:auto}

  table{
    border-collapse:collapse;width:100%;min-width:320px;font-size:.9rem;
    table-layout:fixed;background:#fff;
  }
  th,td{
    border:1px solid #ccc;padding:.45rem .6rem;text-align:left;
    white-space:normal;word-break:break-word;
  }
  table.resp tbody tr:nth-child(even) td{background:var(--row-mint);}
  table.resp thead th{position:sticky;top:0;z-index:2;background:#f7f9ff;}

  a.fac-link{color:#0b63c9;font-weight:700;text-decoration:underline;}
  a.fac-link::after{content:"↗";font-size:.85em;margin-left:.25em;}

  @media(max-width:640px){
    table.resp thead{display:none;}
    table.resp,table.resp tbody,table.resp tr,table.resp td{
      display:block;border:none;width:100%;
    }
    table.resp tbody tr{
      background:#fff;margin:.65rem 0;border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,.06);
    }
    table.resp td{
      display:grid;
      grid-template-columns:minmax(5.5em,32vw) 1fr;
      gap:.6rem;border-bottom:1px dashed #eee;
    }
    table.resp td:last-child{border-bottom:none;}
    table.resp td::before{
      content:attr(data-label);color:#666;font-weight:600;
      white-space:nowrap;
    }
    table.resp td[data-key="name"] a.fac-link{font-size:1.05rem;}
  }

  .page-nav{
    position:sticky;bottom:0;left:0;right:0;
    display:flex;justify-content:space-between;align-items:center;gap:1rem;
    padding:1rem;background:var(--mint);
    box-shadow:0 -2px 6px rgba(0,0,0,.06);
    margin-top:1.2rem;
    text-align:left; /* ナビは通常 */
  }
  .nav-btn{font-weight:700;color:#4d2bb6;text-decoration:none;font-size:1rem;}
  @media(max-width:430px){.nav-btn{font-size:.95rem;}}
  </style>
</head>

<body>
<main class="wrapper">
  <div class="clip-name" data-clip="⭐ フリースクール等"></div>

  <h1 class="badge">
    <img src="https://twemoji.maxcdn.com/v/latest/svg/1f347.svg" alt="">フリースクール等
  </h1>

  <div class="desc">
    民間施設等でも、学習支援や体験活動などを行っています。<br>
    施設によって活動内容・時間・費用などは異なります。<br>
    下の表は群馬県内のフリースクール等をまとめたものです。
    お住まいの<strong>市町村</strong>を選択して近隣の施設だけを見ることもできます。
  </div>

  <!-- フィルタ（中央寄せ） -->
  <div id="filterWrap">
    市町村：
    <select id="selRegion"><option value="ALL">すべて</option></select>
  </div>

  <!-- 表 -->
  <div id="tblWrap">読み込み中…</div>

  <!-- ★ナビ：go()依存をやめて実ファイルへ -->
  <nav class="page-nav" aria-label="ページナビ">
    <a class="nav-btn prev" href="/kuni5.html">＜ 戻る</a>
    <a class="nav-btn next" href="/home.html">メニュー ＞</a>
  </nav>
</main>

<!-- ===== JS（Apps Script → fetch 版） ============================== -->
<script>
/* ---------- 設定（Apps Script デプロイ URL とシート情報） ---------- */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbx4krcccAyVZZA99PJ_-7pCH29O0evjwkRYUQNk4sYWLkv9wAoALUzlVMmADVL2URvGwA/exec';
const SHEET   = 'フリースクール等';     // シート名
const COL_IDX = 2;                      // 市町村列（1 始まり index）

/* ---------- 便利関数 ---------- */
const $sel  = document.getElementById('selRegion');
const $wrap = document.getElementById('tblWrap');

const esc = s => String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const errBox = m => `<div style="padding:.8rem;background:#fff;border:1px solid #ddd;border-radius:8px;">${esc(m)}</div>`;

const normURL = v=>{
  if(!v) return '';
  let u = String(v).trim();
  if(!/^https?:\/\//i.test(u)){
    if(/^[\w-]+(\.[\w-]+)+/.test(u)) u = 'https://'+u; else return '';
  }
  return u;
};

/* ---------- fetch wrapper ---------- */
async function api(params={}){
  const url=new URL(ENDPOINT);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const res=await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error(res.status);
  return res.json();
}

/* ---------- プルダウン ---------- */
async function initRegions(){
  try{
    const list = await api({mode:'regions',sheet:SHEET,col:COL_IDX});
    $sel.insertAdjacentHTML('beforeend', (list||[]).map(r=>`<option>${esc(r)}</option>`).join(''));
    $sel.onchange = ()=> drawTable($sel.value);
    drawTable('ALL');
  }catch(e){
    console.error(e);
    $wrap.innerHTML = errBox('地域一覧の取得に失敗しました');
  }
}

/* ---------- 表 ---------- */
async function drawTable(region){
  $wrap.textContent='読み込み中…';
  try{
    const {head=[],rows=[]}=await api({mode:'table',sheet:SHEET,col:COL_IDX,region});
    if(!rows.length){$wrap.innerHTML=errBox('該当データがありません');return;}

    const norm = s => String(s ?? '').trim();
    const pick = (idx, fallback) => (idx >= 0 ? idx : fallback);

    const nameIdx = pick(head.findIndex(h => /名称|施設名|名前/i.test(norm(h))), 0);
    const urlIdx  = pick(head.findIndex(h => /(url|hp|サイト|リンク)/i.test(norm(h))), -1);
    const prIdx   = pick(head.findIndex(h => /(pr|紹介|内容|特徴|備考|コメント)/i.test(norm(h))), -1);

    const visIdx  = head.map((_, i) => i).filter(i => i !== urlIdx);

    const colgroup='<colgroup>'+visIdx.map(i=>
        i===prIdx   ? '<col style="min-width:28ch;width:36ch;">'
      : i===nameIdx ? '<col style="min-width:16ch;">'
      :               '<col style="min-width:8ch;">'
    ).join('')+'</colgroup>';

    const thead='<thead><tr>'+visIdx.map(i=>`<th>${esc(head[i])}</th>`).join('')+'</tr></thead>';

    const tbody='<tbody>'+rows.map(r=>
      '<tr>'+visIdx.map(i=>{
        let cell=esc(r[i]);
        if(i===nameIdx && urlIdx>=0){
          const link=normURL(r[urlIdx]);
          if(link) cell=`<a class="fac-link" href="${link}" target="_blank" rel="noopener">${cell}</a>`;
        }
        const keyAttr=(i===nameIdx)?' data-key="name"':'';
        return `<td${keyAttr} data-label="${esc(head[i])}">${cell.replace(/\n/g,'<br>')}</td>`;
      }).join('')+'</tr>'
    ).join('')+'</tbody>';

    $wrap.innerHTML = `<div class="table-wrap"><table class="resp">${colgroup}${thead}${tbody}</table></div>`;
  }catch(e){
    console.error(e);
    $wrap.innerHTML = errBox('表データの取得に失敗しました');
  }
}

/* ---------- init ---------- */
initRegions();
</script>
</body>
</html>