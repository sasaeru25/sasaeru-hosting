<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#FFF9F2" />
  <title>è¨˜éŒ²ï½œã•ã•ã‚¨ãƒ¼ãƒ«</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f3a9a0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="icon" href="/icons/favicon-32.png" sizes="32x32">

  <link rel="stylesheet" href="/css/common.css">
  <script src="/js/common.js" defer></script>
  <script src="/js/store.js" defer></script>

  <style>
    :root{
      --bg:#FFF9F2;--accent:#FFDC65;--border:#e6e6e6;--purple:#6a1b9a;--safe-bottom:env(safe-area-inset-bottom);
      --sh-1:0 3px 10px rgba(0,0,0,.08);
    }
    body{background:var(--bg);margin:0;}
    .diary-page{box-sizing:border-box;max-width:560px;margin:0 auto;padding:18px 16px 28px;color:#333;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;text-align:center;}
    .page-head{display:flex;justify-content:center;margin-bottom:10px;}
    .page-head h2{margin:0;display:inline-flex;align-items:center;gap:10px;padding:10px 22px;border-radius:999px;background:#fff;border:1px solid var(--border);font-weight:900;font-size:1.05rem;}

    .actions{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin:6px 0 10px;
    }

    /* æ—¢å­˜ã® btn-link ã¯ãã®ã¾ã¾ä½¿ã† */
    .btn-link{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:64px;
      min-width:240px;
      padding:16px 20px;
      border-radius:18px;
      background:#fff;
      border:1px solid #ddd;
      text-decoration:none;
      color:#111;
      font-weight:900;
      font-size:1.15rem;
      box-shadow:0 10px 16px rgba(0,0,0,.10);
    }
    .btn-link:visited{color:#111;}

    /* CLICK HEREã ã‘å°ã•ãï¼ˆãƒ”ãƒ«ã£ã½ãï¼‰ */
    .btn-link.btn-mini{
      min-height:44px;
      min-width:180px;
      padding:10px 18px;
      border-radius:999px;
      font-size:1rem;
    }

    /* ã‚¹ãƒãƒ›ï¼šå¤§ãƒœã‚¿ãƒ³ã¯å¹…100%ã€CLICK HEREã¯ä¸­å¤®ã§å°ã•ã‚ç¶­æŒ */
    @media(max-width:430px){
      .btn-link{min-width:100%;}
      .btn-link.btn-mini{min-width:180px;width:auto;}
    }

    .btn-link.btn-mini{
      min-height:44px;
      min-width:180px;
      padding:10px 18px;
      border-radius:999px;
      font-size:1rem;
    }

    /* ã‚¹ãƒãƒ›ï¼šå¤§ãƒœã‚¿ãƒ³ã¯å¹…100%ã€CLICK HEREã¯ä¸­å¤®ã§å°ã•ã‚ç¶­æŒ */
    @media(max-width:430px){
      .btn-link{min-width:100%;}
      .btn-link.btn-mini{min-width:180px;width:auto;}
    }

    .section{margin-top:14px;background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;box-shadow:0 3px 10px rgba(0,0,0,.06);text-align:left;}
    .section h3{margin:0 0 6px;font-size:1rem;font-weight:900;}
    .stat{font-size:12px;color:#666;margin:-2px 0 10px;text-align:center;}
    .banners{display:flex;flex-direction:column;gap:10px;}
    .banner{width:100%;appearance:none;border:none;cursor:pointer;background:var(--accent);border-radius:999px;padding:12px 16px;font-weight:900;font-size:1.05rem;text-align:center;
      box-shadow:0 6px 10px rgba(0,0,0,.10);}
    .empty{color:#666;text-align:center;margin:14px 0;line-height:1.9;}
    .bottom-row{margin-top:16px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .link{color:var(--purple);text-decoration:none;font-weight:900;}
    main{padding-bottom:calc(28px + var(--safe-bottom));}

    /* modal */
    .modal[hidden]{display:none!important;}
    .modal{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.45);display:flex;align-items:flex-end;justify-content:center;padding:14px;}
    .sheet{width:min(640px,100%);max-height:85vh;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;display:flex;flex-direction:column;}
    .sheet-head{padding:12px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
    .chip{background:var(--accent);border-radius:999px;padding:6px 12px;font-weight:900;}
    .sheet-body{padding:14px;overflow:auto;}
    .fulltext{white-space:pre-wrap;line-height:1.75;font-size:1rem;}
    .sheet-actions{border-top:1px solid #eee;padding:12px 14px;display:flex;justify-content:flex-end;}
    .mbtn{padding:10px 16px;border-radius:12px;border:1px solid #ef4444;background:#fff;color:#ef4444;font-weight:900;cursor:pointer;}
    #m-close{border:1px solid #ddd;background:#fff;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer;}

    /* iPhone backup entry */
    .backup-details{max-width:560px;margin:0 auto 10px;text-align:left;}
    .backup-details summary{background:#fff;border-radius:12px;padding:12px 14px;box-shadow:var(--sh-1);cursor:pointer;list-style:none;border:1px solid #eee;}
    .backup-details summary::-webkit-details-marker{display:none;}
    .backup-box{background:#fff;border-radius:12px;padding:12px 14px;margin-top:10px;box-shadow:var(--sh-1);border:1px solid #eee;}
    .muted{color:#666;font-size:.92rem;line-height:1.7;margin:0 0 10px;}

    /* === ãƒšãƒ¼ã‚¸ãƒ£ç”¨ã‚¹ã‚¿ã‚¤ãƒ« === */
    .pager-row{
      display:flex;
      gap:6px;
      justify-content:center;
      margin-top:16px;
      flex-wrap:nowrap;
      align-items:center;
    }
    .pager-info{
      font-weight:700;
      font-size:.9rem;
    }
    /* ãƒšãƒ¼ã‚¸ãƒ£å†…ã®ãƒœã‚¿ãƒ³ã ã‘å°ã•ã‚ã«ã™ã‚‹ï¼ˆCLICK HERE ã«ã¯å½±éŸ¿ã—ãªã„ï¼‰ */
    .pager-row .btn-link.btn-mini{
      min-width:auto;
      padding:8px 12px;
      font-size:.9rem;
    }
  </style>
</head>

<body>
  <main class="diary-page">
    <div class="page-head"><h2>ğŸ¤ è¨˜éŒ² ğŸ¤</h2></div>

    <details id="backup-details" class="backup-details" hidden>
      <summary>ğŸ”’ ç«¯æœ«ã«ã¡ã‚ƒã‚“ã¨æ®‹ã™ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</summary>
      <div class="backup-box">
        <p class="muted">
          iPhoneã§ã¯ç’°å¢ƒã«ã‚ˆã‚Šã€è¨˜éŒ²ãŒæ¶ˆãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>
          å¿µã®ãŸã‚ã€ç«¯æœ«ã«æ®‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
        </p>
        <a class="btn-link" style="min-height:52px;font-size:1rem;" href="/backup.html">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”»é¢ã‚’é–‹ã</a>
      </div>
    </details>

    <div class="actions">
      <a class="btn-link btn-mini" href="/diary-guide.html">CLICK HERE</a>
      <a class="btn-link" href="/diary-new.html">ï¼‹ æ–°è¦ä½œæˆ</a>
    </div>

    <section class="section">
      <h3>æœ€æ–°ã®è¨˜éŒ²</h3>
      <div class="stat" id="stat"></div>
      <div class="banners" id="banners"></div>
      <div class="empty" id="empty" hidden>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“<br>ã€Œï¼‹ æ–°è¦ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†</div>

      <div class="bottom-row">
        <a class="link" href="/diary-list.html">â† ä¸€è¦§è¡¨ç¤º</a>
        <!-- â˜…iPhoneã ã‘è¡¨ç¤ºï¼ˆGASç‰ˆã¨åŒã˜æ–¹é‡ï¼‰ -->
        <a class="link" href="/backup.html" id="backup-link" hidden>ç«¯æœ«ã«æ®‹ã™</a>
      </div>

      <!-- â–¼ ãƒšãƒ¼ã‚¸ãƒ£ï¼ˆ20ä»¶ã”ã¨ï¼‰ -->
      <div class="pager-row" id="pager" aria-labelledby="pg-info" hidden>
        <button id="pg-prev" class="btn-link btn-mini" type="button">â† å‰ã®20ä»¶</button>
        <span   id="pg-info" class="pager-info" aria-live="polite"></span>
        <button id="pg-next" class="btn-link btn-mini" type="button">æ¬¡ã®20ä»¶ â†’</button>
      </div>
      <!-- â–² ãƒšãƒ¼ã‚¸ãƒ£ã“ã“ã¾ã§ -->
    </section>
  </main>

  <div class="modal" id="modal" hidden>
    <div class="sheet">
      <div class="sheet-head">
        <span class="chip" id="m-date"></span>
        <button id="m-close" type="button">é–‰ã˜ã‚‹</button>
      </div>
      <div class="sheet-body">
        <div class="fulltext" id="m-body"></div>
      </div>
      <div class="sheet-actions">
        <button class="mbtn" id="m-del" type="button">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* â–¼ ãƒšãƒ¼ã‚¸ãƒ£ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ20ä»¶ã”ã¨ï¼‰ */
    const PAGE_SIZE = 20;
    const curPg = () =>
      Math.max(1, +(new URL(location.href).searchParams.get('p') || 1));
    const pagesOf = (n) =>
      Math.max(1, Math.ceil(n / PAGE_SIZE));
    const goPage = (p) => {
      const u = new URL(location.href);
      u.searchParams.set('p', p);
      location.href = u.toString();
    };
    /* â–² ãƒšãƒ¼ã‚¸ãƒ£ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */

    // â˜…iPhoneã ã‘ï¼šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¡ˆå†…ï¼ˆGASç‰ˆã¨åŒã˜æ–¹é‡ï¼‰
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isIOS) {
      document.getElementById('backup-details')?.removeAttribute('hidden');
      document.getElementById('backup-link')?.removeAttribute('hidden');
    }

    (async () => {
      const { loadRecords, saveRecords } = window;
      if (typeof loadRecords !== 'function' || typeof saveRecords !== 'function') {
        console.warn('[diary] store api missing');
        return;
      }

      const $banners = document.getElementById('banners');
      const $empty   = document.getElementById('empty');
      const $stat    = document.getElementById('stat');

      const $modal = document.getElementById('modal');
      const $mDate = document.getElementById('m-date');
      const $mBody = document.getElementById('m-body');
      const $mClose= document.getElementById('m-close');
      const $mDel  = document.getElementById('m-del');

      let current = null;
      const label = d => `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;

      const openModal = rec => {
        current = rec;
        const d = new Date(rec.recordDate ?? rec.createdAt);
        $mDate.textContent = rec.dateText || label(d);
        $mBody.textContent = rec.content || '';
        $modal.hidden = false;
      };
      const closeModal = () => { $modal.hidden = true; current = null; };
      $mClose.onclick = closeModal;
      $modal.onclick = e => { if (e.target === $modal) closeModal(); };

      $mDel.onclick = async () => {
        if (!current) return;
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const list = await loadRecords();
        await saveRecords((list||[]).filter(r => r.id !== current.id));
        closeModal();
        await draw();
      };

      async function draw(){
        const list = (await loadRecords() || []).slice()
          .sort((a,b) => (b.recordDate ?? b.createdAt) - (a.recordDate ?? a.createdAt));

        $banners.innerHTML = '';

        const pager = document.getElementById('pager');
        const info  = document.getElementById('pg-info');
        const prev  = document.getElementById('pg-prev');
        const next  = document.getElementById('pg-next');

        // 0ä»¶å‡¦ç†
        if (!list.length) {
          $empty.hidden = false;
          $stat.textContent = 'ä¿å­˜ä»¶æ•°: 0 / æœ€çµ‚è¨˜éŒ²: ãªã—';
          if (pager) pager.hidden = true;
          return;
        }
        $empty.hidden = true;

        // ãƒšãƒ¼ã‚¸è¨ˆç®—
        const maxP = pagesOf(list.length);
        const page = Math.min(curPg(), maxP);
        const start = (page - 1) * PAGE_SIZE;
        const end   = page * PAGE_SIZE;
        const slice = list.slice(start, end);

        // ä»¶æ•°è¡¨ç¤ºï¼ˆæœ€æ–°1ä»¶ã‹ã‚‰ï¼‰
        const newest = list[0];
        const ts     = newest.recordDate ?? newest.createdAt;
        $stat.textContent =
          `ä¿å­˜ä»¶æ•°: ${list.length} / æœ€çµ‚è¨˜éŒ²: ${newest.dateText || label(new Date(ts))}`;

        // ãƒãƒŠãƒ¼æç”»ï¼ˆç¾åœ¨ãƒšãƒ¼ã‚¸åˆ†ã ã‘ï¼‰
        slice.forEach(rec => {
          const d = new Date(rec.recordDate ?? rec.createdAt);
          const btn = document.createElement('button');
          btn.className = 'banner';
          btn.textContent = rec.dateText || label(d);
          btn.onclick = () => openModal(rec);
          $banners.appendChild(btn);
        });

        // ãƒšãƒ¼ã‚¸ãƒ£æ›´æ–°
        if (pager && info && prev && next) {
          info.textContent = `ãƒšãƒ¼ã‚¸ ${page} / ${maxP}`;
          prev.disabled = page <= 1;
          next.disabled = page >= maxP;
          prev.onclick  = () => { if (page > 1) goPage(page - 1); };
          next.onclick  = () => { if (page < maxP) goPage(page + 1); };
          pager.hidden  = (maxP <= 1); // 1ãƒšãƒ¼ã‚¸ã ã‘ãªã‚‰éè¡¨ç¤º
        }
      }

      draw();
    })();
  });
  </script>
</body>
</html>