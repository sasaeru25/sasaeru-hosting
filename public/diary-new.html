<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>＋ 新規作成</title>

  <!-- ★ PWA ------------------------------------------- -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#FFF9F2">

  <!-- 共通 CSS / JS があるならここで読み込む -->
  <link rel="stylesheet" href="/css/common.css">
  <!-- -------------------------------------------------- -->

  <style>
    :root{
      --bg:#FFF9F2; --card:#ffffff; --accent:#FFDC65; --border:#e6e6e6;
      --ink:#333; --purple:#6a1b9a; --safe-bottom:env(safe-area-inset-bottom);
    }
    body{background:var(--bg);}

    .diary-new-page{box-sizing:border-box;max-width:560px;margin:0 auto;
      padding:18px 16px 28px;color:var(--ink);
      font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;}

    .page-head{display:flex;justify-content:center;margin-bottom:14px;text-align:center;}
    .page-head h2{margin:0;display:inline-flex;gap:10px;align-items:center;
      padding:10px 22px;border-radius:999px;background:#fff;border:1px solid var(--border);
      font-weight:900;font-size:1.05rem;}

    .card{background:var(--card);border:1px solid #eee;border-radius:12px;
      padding:14px;box-shadow:0 3px 10px rgba(0,0,0,.06);}

    label{display:block;font-weight:900;margin:10px 0 6px;}

    input[type=date],textarea{width:100%;box-sizing:border-box;padding:12px;
      border-radius:12px;border:1px solid #ddd;font-size:1rem;}
    textarea{min-height:220px;resize:vertical;line-height:1.7;}

    .hint{color:#666;font-size:.95rem;line-height:1.6;margin-top:6px;}

    .btn-row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;}
    .btn{border:none;cursor:pointer;border-radius:16px;padding:14px 16px;
      font-weight:900;font-size:1.05rem;box-shadow:0 10px 16px rgba(0,0,0,.10);
      flex:1 1 200px;}
    .btn-save{background:var(--accent);color:#111;}
    .btn-cancel{background:#fff;border:1px solid #ddd;color:var(--purple);box-shadow:none;}

    main{padding-bottom:calc(28px + var(--safe-bottom));}
  </style>
</head>

<body>
<main class="diary-new-page">
  <div class="page-head"><h2>＋ 新規作成</h2></div>

  <section class="card">
    <label for="date">日付</label>
    <input id="date" type="date">

    <label for="content">内容</label>
    <textarea id="content" placeholder="例：子どもの様子／自分の気持ち／試したこと など"></textarea>

    <div class="hint">※ この記録は端末内に保存されます（最大 100 件）。</div>

    <div class="btn-row">
      <button class="btn btn-save" id="save" type="button">保存</button>
      <a class="btn btn-cancel" href="?page=diary">キャンセル</a>
    </div>
  </section>
</main>

<!-- 共通 JS（Service Worker 登録など） -->
<script src="/js/common.js" defer></script>

<script type="module">
import { loadRecords, saveRecords } from '/js/store.js';   // ← パスは構成に合わせて

/* ---------- util ---------- */
const pad = n=>String(n).padStart(2,'0');
const todayISO = ()=>{
  const d=new Date();return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
const toLabel = iso=>{
  const d=new Date(iso+'T00:00');return`${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
};

/* ---------- 初期値 ---------- */
document.getElementById('date').value ||= todayISO();

/* ---------- 保存 ---------- */
document.getElementById('save').addEventListener('click', async function(){
  if(!loadRecords||!saveRecords){alert('保存 API が準備できていません');return;}

  const iso = document.getElementById('date').value.trim();
  const txt = document.getElementById('content').value.trim();
  if(!iso || !txt){alert('日付と内容を入力してください');return;}

  const list = await loadRecords() ?? [];
  if(list.length >= 100){alert('上限 100 件に達しました');return;}

  /* 即時フィードバック */
  this.textContent='保存しました';
  this.disabled   = true;
  this.style.cssText='background:#fff;color:#6a1b9a;border:1px solid #ddd;';

  const now = Date.now();
  list.push({
    id:String(now)+'-'+Math.random().toString(16).slice(2),
    createdAt:now,
    recordDate:new Date(iso+'T00:00').getTime(),
    dateText:toLabel(iso),
    content:txt
  });

  await saveRecords(list);                    // IndexedDB 保存

  /* （任意）初回だけ iPhone へバックアップ案内 */
  try{ window.__sasaeru?.maybePromptBackupOnce?.(); }catch(e){}

  location.href='?page=diary';                // トップへ戻る
});
</script>
</body>
</html>
