<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>教育支援センター</title>

  <link rel="stylesheet" href="/css/common.css">
  <script defer src="/js/lib.js"></script>
  <script defer src="/js/store.js"></script>

  <style>
    :root{--mint:#caf4d6;--accent:#7e57c2;--shadow:0 6px 12px rgba(0,0,0,.15);}
    body{margin:0;background:var(--mint);font-family:"Noto Sans JP",system-ui,sans-serif;color:#222;}
    .wrapper{max-width:430px;margin:0 auto;padding:1rem;}
    .badge{display:inline-block;padding:.65rem 2rem;margin:0 0 22px;border-radius:999px;
      background:linear-gradient(180deg,#fff,#f3f4f8);box-shadow:var(--shadow);
      font-size:clamp(18px,5vw,26px);font-weight:700;}
    .badge img{width:1.4em;vertical-align:-.2em;margin-right:.2em}
    .desc{background:#fff;padding:1.4rem .9rem;margin-bottom:1.8rem;line-height:1.7;
      font-size:clamp(14px,4.2vw,17px);box-shadow:0 3px 6px rgba(0,0,0,.1);text-align:left;}
    #filterWrap{margin-bottom:1rem;font-size:1rem;}
    #selRegion{font-size:1rem;padding:.3rem .6rem;}
    #tblWrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
    table{border-collapse:collapse;width:100%;min-width:320px;font-size:.9rem;background:#fff;}
    th,td{border:1px solid #ccc;padding:.45rem .6rem;white-space:nowrap;text-align:left;}
    th{background:#f3f6ff;font-weight:600;}
    table.hide-col-4 th:nth-child(4), table.hide-col-4 td:nth-child(4){display:none;}
    @media(max-width:380px){.desc{font-size:15px;} table{font-size:.8rem;}}
    a.fac-link{color:#0b63c9;font-weight:700;text-decoration:underline;}
    a.fac-link::after{content:"↗";font-size:.85em;margin-left:.25em;}
    .page-nav{display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:1rem .5rem;margin-top:1.2rem;background:var(--mint);}
    .nav-btn{background:transparent;border:none;padding:.6rem .2rem;color:var(--accent);
      font-weight:700;text-decoration:none;}
    .nav-btn:hover{text-decoration:underline;}
    .nav-btn:active{transform:translateY(1px);}
  </style>
</head>

<body>
<main class="wrapper">
  <div class="clip-name" data-clip="⭐ 教育支援センター"></div>

  <h1 class="badge">
    <img src="https://twemoji.maxcdn.com/v/latest/svg/1f34a.svg" alt="">教育支援センター
  </h1>

  <div class="desc">
    児童生徒の社会的自立や学校復帰に向けて、市町村の教育委員会が設置している施設です。<br>
    学校と連携を取りながら、学習支援や体験活動などを行っています。<br>
    下の表では群馬県内に設置されている教育支援センターを紹介しています。
    お住まいの<strong>市町村</strong>を選択して近隣の施設を絞り込むこともできます。
  </div>

  <div id="filterWrap">
    市町村：
    <select id="selRegion"><option value="ALL">すべて</option></select>
  </div>

  <div id="tblWrap">読み込み中…</div>

  <!-- ★リンクだけこの版の意図に合わせる -->
  <nav class="page-nav" aria-label="ページナビ">
    <button type="button" class="nav-btn prev" onclick="go('soudankikan2')">＜ 戻る</button>
    <button type="button" class="nav-btn next" onclick="go('freeschool3')">進む ＞</button>
  </nav>
</main>

<script>
/* ===== Firebase版：fetchでGAS WebApp(JSON)を読む ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbx4krcccAyVZZA99PJ_-7pCH29O0evjwkRYUQNk4sYWLkv9wAoALUzlVMmADVL2URvGwA/exec';
const CFG = { sheetName:'教育支援センター', filterCol:2 };

/* ---------- util ---------- */
function normURL(v){
  if(!v) return '';
  let u = String(v).trim();
  if(!/^https?:\/\//i.test(u)){
    if(/^[\w-]+(\.[\w-]+)+/.test(u)) u = 'https://' + u;
    else return '';
  }
  return u;
}
function showError(where, err){
  console.error(where, err);
  document.getElementById('tblWrap').innerHTML =
    `<div style="padding:.8rem;background:#fff;border:1px solid #ddd;border-radius:8px;">
       データ取得でエラーが発生しました。<br><small>${where}</small>
     </div>`;
}

/* ---------- API(fetch) ---------- */
async function api(params = {}){
  const url = new URL(ENDPOINT);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

/* ---------- 地域プルダウン ---------- */
async function loadRegions(){
  try{
    const list = await api({ mode:'regions', sheet:CFG.sheetName, col:CFG.filterCol });
    const sel = document.getElementById('selRegion');
    sel.insertAdjacentHTML('beforeend', (list||[]).map(r=>`<option>${r}</option>`).join(''));
    sel.addEventListener('change', () => loadTable(sel.value));
    loadTable('ALL');
  }catch(e){
    showError('地域一覧取得に失敗', e);
  }
}

/* ---------- 表 ---------- */
async function loadTable(region){
  const wrap = document.getElementById('tblWrap');
  wrap.textContent = '読み込み中…';
  try{
    const data = await api({ mode:'table', sheet:CFG.sheetName, col:CFG.filterCol, region });
    drawTable(data);
  }catch(e){
    showError('表データ取得に失敗', e);
  }
}
function drawTable({head=[],rows=[]}={}){
  const wrap = document.getElementById('tblWrap');
  if(!rows.length){ wrap.textContent='該当データがありません'; return; }

  const nameIdx=2, urlIdx=3;
  const thead = `<thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r =>
    `<tr>${r.map((c,i)=>{
      if(i===nameIdx){
        const link = normURL(r[urlIdx]);
        if(link) return `<td><a class="fac-link" href="${link}" target="_blank" rel="noopener">${c??''}</a></td>`;
      }
      return `<td>${c??''}</td>`;
    }).join('')}</tr>`
  ).join('')}</tbody>`;

  wrap.innerHTML = `<table class="hide-col-4">${thead}${tbody}</table>`;
}

/* ---------- 起動 ---------- */
loadRegions();
</script>
</body>
</html>
