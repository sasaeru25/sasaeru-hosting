<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ã‚¯ãƒªãƒƒãƒ—ä¸€è¦§</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffe6e6">

  <link rel="stylesheet" href="/css/common.css">
  <script defer src="/js/lib.js"></script>
  <script defer src="/js/store.js"></script>

  <style>
    :root{ --bg:#ffe6e6; --purple:#6a1b9a; }
    body{background:var(--bg);margin:0;color:#333;
         font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;}
    .clip-page{box-sizing:border-box;max-width:720px;margin:0 auto;padding:18px 16px 28px;}
    .page-head{display:flex;justify-content:center;margin-bottom:12px;}
    .page-head h2{margin:0;font-size:1.05rem;padding:.35rem .9rem;
                  background:#fff;border:1px solid #eee;border-radius:999px;}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;
          box-shadow:0 3px 10px rgba(0,0,0,.06);margin:10px 0 14px;}
    .sec-title{margin:.2rem 0 .6rem;font-size:1rem;color:#555;}

    .clip-list{display:grid;gap:10px;}
    .clip-item{display:flex;align-items:center;gap:10px;padding:10px;
               border:1px solid #eee;border-radius:10px;}
    .clip-link{flex:1;text-decoration:none;color:#333;font-weight:700;
               overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .clip-list p{margin:16px 0;color:#777;}

    .bottom-nav{display:flex;justify-content:center;gap:16px;background:var(--bg);
                padding:12px 16px;margin:18px -16px 0;}
    .purple{color:var(--purple);text-decoration:none;font-weight:700;background:transparent;border:none;cursor:pointer;}
  </style>
</head>

<body>
<main class="clip-page" aria-labelledby="clip-title">
  <div class="page-head"><h2 id="clip-title">ğŸ¤ ã‚¯ãƒªãƒƒãƒ—ä¸€è¦§ ğŸ¤</h2></div>

  <section class="card" id="list-area" aria-label="ã‚¯ãƒªãƒƒãƒ—ä¸€è¦§"></section>

  <nav class="bottom-nav" aria-label="ä¸‹éƒ¨ãƒŠãƒ“">
    <button type="button" class="purple" onclick="go('home')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  </nav>
</main>

<script>
(() => {
  /* store.js ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤ï¼ˆbackup.htmlã¨åŒã˜æ–¹å¼ï¼‰ */
  const ready = () => new Promise(r => {
    if (window.__STORE_READY__) return r();
    const id = setInterval(() => {
      if (window.__STORE_READY__ || window.__STORE_ERROR__) { clearInterval(id); r(); }
    }, 50);
  });

  const resolveLabel = it =>
    (it?.preview && String(it.preview).trim()) ||
    (it?.title   && String(it.title).trim())   ||
    (it?.label   && String(it.label).trim())   ||
    (it?.name    && String(it.name).trim())    ||
    (it?.url     && String(it.url).trim())     ||
    'ï¼ˆç„¡é¡Œï¼‰';

  function isInternalClip(it){
    // 1) æ˜ç¤ºã‚­ãƒ¼ï¼ˆæ¨å¥¨ï¼‰
    if (it?.page) return { type:'go', key:String(it.page) };

    const u = (it?.url || '').toString().trim();

    // 2) "?page=xxx" å½¢å¼
    const m = u.match(/[?&]page=([^&#]+)/);
    if (m) return { type:'go', key:decodeURIComponent(m[1]) };

    // 3) "/xxx.html" å½¢å¼
    if (/^\/[^?#]+\.html$/i.test(u)) return { type:'href', href:u };

    return null; // å¤–éƒ¨
  }

  function itemRow(it){
    const row = document.createElement('div');
    row.className = 'clip-item';

    const a = document.createElement('a');
    a.className = 'clip-link';
    a.textContent = resolveLabel(it);

    const internal = isInternalClip(it);

    if (internal?.type === 'go') {
      a.href = 'javascript:void(0)';
      a.addEventListener('click', () => window.go ? go(internal.key) : (location.href='/' + internal.key + '.html'));
    } else if (internal?.type === 'href') {
      a.href = internal.href;
    } else {
      const url = (it?.url || '').toString().trim();
      a.href = url || 'javascript:void(0)';
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
    }

    row.appendChild(a);
    return row;
  }

  async function render(){
    const area = document.getElementById('list-area');
    area.innerHTML = '';

    const h = document.createElement('h3');
    h.className = 'sec-title';
    h.textContent = 'ã‚¯ãƒªãƒƒãƒ—';

    const list = document.createElement('div');
    list.className = 'clip-list';

    const load = window.loadClips;
    if (typeof load !== 'function') {
      list.innerHTML = '<p>ã‚¯ãƒªãƒƒãƒ—æ©Ÿèƒ½ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆstore.js ã‚’ç¢ºèªï¼‰</p>';
      area.append(h, list);
      return;
    }

    const data = (await load()) || [];
    data.sort((a,b)=>(b.clippedAt ?? 0) - (a.clippedAt ?? 0));

    if (data.length) data.forEach(it => list.appendChild(itemRow(it)));
    else list.innerHTML = '<p>ã‚¯ãƒªãƒƒãƒ—ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';

    area.append(h, list);
  }

  ready().then(render);
})();
</script>
</body>
</html>
