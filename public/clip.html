<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ã‚¯ãƒªãƒƒãƒ—ä¸€è¦§</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffe6e6">

  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#f3a9a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
<link rel="icon" href="/icons/favicon-32.png" sizes="32x32">

<link rel="stylesheet" href="/css/common.css">
<script src="/js/common.js" defer></script>
<script src="/js/lib.js" defer></script>
<script src="/js/store.js" defer></script>


  <style>
    :root{ --bg:#ffe6e6; --purple:#6a1b9a; }
    body{background:var(--bg);margin:0;color:#333;
         font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;}
    .clip-page{box-sizing:border-box;max-width:720px;margin:0 auto;padding:18px 16px 28px;}
    .page-head{display:flex;justify-content:center;margin-bottom:12px;}
    .page-head h2{margin:0;font-size:1.05rem;padding:.35rem .9rem;
                  background:#fff;border:1px solid #eee;border-radius:999px;}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;
          box-shadow:0 3px 10px rgba(0,0,0,.06);margin:10px 0 14px;}
    .sec-title{margin:.2rem 0 .6rem;font-size:1rem;color:#555;}

    .clip-list{display:grid;gap:10px;}
    .clip-item{display:flex;align-items:center;gap:10px;padding:10px;
               border:1px solid #eee;border-radius:10px;}
    .clip-link{flex:1;text-decoration:none;color:#333;font-weight:700;
               overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .clip-list p{margin:16px 0;color:#777;}

    .bottom-nav{display:flex;justify-content:center;gap:16px;background:var(--bg);
                padding:12px 16px;margin:18px -16px 0;}
    .purple{color:var(--purple);text-decoration:none;font-weight:700;background:transparent;border:none;cursor:pointer;}
  </style>
</head>

<body>
<main class="clip-page" aria-labelledby="clip-title">
  <div class="page-head"><h2 id="clip-title">ğŸ¤ ã‚¯ãƒªãƒƒãƒ—ä¸€è¦§ ğŸ¤</h2></div>

  <section class="card" id="list-area" aria-label="ã‚¯ãƒªãƒƒãƒ—ä¸€è¦§">
  <p id="clip-empty" style="margin:16px 0;color:#777;">ã‚¯ãƒªãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</p>
</section>

  <nav class="bottom-nav" aria-label="ä¸‹éƒ¨ãƒŠãƒ“">
    <button type="button" class="purple" onclick="go('home')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
  </nav>
</main>

<script>
(() => {
  // store.js å¾…ã¡ï¼ˆå¾…ã¡ã™ããªã„ï¼‰
  const ready = (timeoutMs = 2000) => new Promise((resolve) => {
    const t0 = Date.now();
    if (window.__STORE_READY__ || window.__STORE_ERROR__) return resolve();
    const id = setInterval(() => {
      if (window.__STORE_READY__ || window.__STORE_ERROR__) {
        clearInterval(id); resolve(); return;
      }
      if (Date.now() - t0 > timeoutMs) {
        clearInterval(id); resolve(); return;
      }
    }, 50);
  });

  const resolveLabel = it =>
    (it?.preview && String(it.preview).trim()) ||
    (it?.title   && String(it.title).trim())   ||
    (it?.label   && String(it.label).trim())   ||
    (it?.name    && String(it.name).trim())    ||
    (it?.url     && String(it.url).trim())     ||
    'ï¼ˆç„¡é¡Œï¼‰';

  function isInternalClip(it){
    if (it?.page) return { type:'go', key:String(it.page) };

    const u = (it?.url || '').toString().trim();
    const m = u.match(/[?&]page=([^&#]+)/);
    if (m) return { type:'go', key:decodeURIComponent(m[1]) };

    if (/^\/[^?#]+\.html$/i.test(u)) return { type:'href', href:u };
    return null;
  }

  function itemRow(it){
    const row = document.createElement('div');
    row.className = 'clip-item';

    const a = document.createElement('a');
    a.className = 'clip-link';
    a.textContent = resolveLabel(it);

    const internal = isInternalClip(it);

    if (internal?.type === 'go') {
      a.href = 'javascript:void(0)';
      a.addEventListener('click', () => window.go ? go(internal.key) : (location.href='/' + internal.key + '.html'));
    } else if (internal?.type === 'href') {
      a.href = internal.href;
    } else {
      const url = (it?.url || '').toString().trim();
      a.href = url || 'javascript:void(0)';
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
    }

    row.appendChild(a);
    return row;
  }

  async function render(){
    const area = document.getElementById('list-area');
    if (!area) return;

    // ã¾ãšã¯ã€Œã‚¯ãƒªãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€ã‚’ç¢ºå®Ÿã«è¦‹ã›ã‚‹ï¼ˆJSãŒè½ã¡ã¦ã‚‚OKï¼‰
    const emptyEl = document.getElementById('clip-empty');
    if (emptyEl) emptyEl.style.display = 'block';

    // store.js ãŒãªã„/å£Šã‚Œã¦ã¦ã‚‚ â€œç©ºè¡¨ç¤ºâ€ ã‚’æ®‹ã—ãŸã¾ã¾ã«ã™ã‚‹
    const load = window.loadClips;
    if (typeof load !== 'function') {
      return; // clip-empty ãŒè¦‹ãˆã¦ã‚‹ã®ã§OK
    }

    let data = [];
    try {
      data = (await load()) || [];
    } catch (e) {
      console.log('loadClips error:', e);
      return; // clip-empty ãŒè¦‹ãˆã¦ã‚‹ã®ã§OK
    }

    data.sort((a,b)=>(b.clippedAt ?? 0) - (a.clippedAt ?? 0));

    // ä¸€è¦§ãŒã‚ã‚‹ãªã‚‰ç©ºè¡¨ç¤ºã‚’æ¶ˆã—ã¦æç”»
    if (data.length) {
      if (emptyEl) emptyEl.style.display = 'none';

      area.innerHTML = '';
      const h = document.createElement('h3');
      h.className = 'sec-title';
      h.textContent = 'ã‚¯ãƒªãƒƒãƒ—';

      const list = document.createElement('div');
      list.className = 'clip-list';
      data.forEach(it => list.appendChild(itemRow(it)));

      area.append(h, list);
    } else {
      // 0ä»¶ãªã‚‰ clip-empty ã‚’ãã®ã¾ã¾è¡¨ç¤ºï¼ˆæ–‡è¨€ã¯HTMLå´ï¼‰
      if (emptyEl) emptyEl.style.display = 'block';
    }
  }

  // å…ˆã«æç”»â†’æº–å‚™å¾Œã«å†æç”»ï¼ˆçœŸã£ç™½é˜²æ­¢ï¼‰
  render();
  ready().then(render);
})();
</script></body>
</html>
